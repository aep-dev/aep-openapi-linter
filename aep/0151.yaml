aliases:
  AcceptedResponse:
    description: An operation that returns 202 Accepted for long-running operations
    targets:
      - formats: ['oas2', 'oas3']
        given:
          - $.paths[*].[post,put,patch,delete].responses.202^^

functionsDir: ../functions
functions:
  - operations-endpoint

rules:
  aep-151-202-only-success:
    description: Long-running operations must return 202 as the only success status code
    message: Long-running operations must return 202 as the only success status code
    severity: error
    formats: ['oas2', 'oas3']
    given:
      - '#AcceptedResponse.responses'
    then:
      function: schema
      functionOptions:
        schema:
          not:
            anyOf:
              - required: ['200']
              - required: ['201']
              - required: ['204']

  aep-151-202-schema-required:
    description: A 202 response must define an application/json response body with Operation schema
    severity: error
    formats: ['oas3']
    given:
      - '#AcceptedResponse.responses.202'
    then:
      function: schema
      functionOptions:
        schema:
          type: object
          required: ['content']
          properties:
            content:
              type: object
              required: ['application/json']
              properties:
                'application/json':
                  type: object
                  required: ['schema']

  aep-151-operation-schema:
    description: Operation schema must have correct property types
    message: Operation schema must have correct property types
    severity: error
    formats: ['oas3']
    given:
      - '#AcceptedResponse.responses.202.content.application/json.schema'
    then:
      function: schema
      functionOptions:
        schema:
          type: object
          required: ['properties']
          properties:
            properties:
              type: object
              required: ['path', 'done', 'error', 'response']
              properties:
                path:
                  type: object
                  required: ['type']
                  properties:
                    type:
                      enum: ['string']
                done:
                  type: object
                  required: ['type']
                  properties:
                    type:
                      enum: ['boolean']
                error:
                  type: object
                response:
                  type: object

  aep-151-operations-endpoint:
    description: Services with long-running operations must define an operations endpoint
    message: '{{error}}'
    severity: error
    formats: ['oas2', 'oas3']
    given: $.paths
    then:
      function: operations-endpoint
